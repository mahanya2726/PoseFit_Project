{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file://C%3A/Users/mahan/ProjectsNew/Python/coach/aicoach/src/app/session/start/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { useEffect, useRef, useState } from \"react\";\r\n\r\nexport default function StartExercisePage() {\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\r\n  const [stream, setStream] = useState<MediaStream | null>(null);\r\n  const [countdown, setCountdown] = useState<number | null>(5);\r\n  const [timer, setTimer] = useState<number | null>(null);\r\n  const [recordedChunks, setRecordedChunks] = useState<Blob[]>([]);\r\n  const [videoURL, setVideoURL] = useState<string | null>(null);\r\n  const [sessionStarted, setSessionStarted] = useState(false);\r\n\r\n  const audioRef = useRef<HTMLAudioElement | null>(null);\r\n\r\n  const songMap: Record<string, string> = {\r\n    better: \"/better-day-workout-beat.mp3\",\r\n    bouncy: \"/bouncy-workout.mp3\",\r\n    order: \"/order.mp3\",\r\n    workout1: \"/sport-gym-workout -music-1.mp3\",\r\n    workout2: \"/sport-gym-workout-music-2.mp3\",\r\n    metal: \"/workout -metal.mp3\",\r\n    workout: \"/workout.mp3\",\r\n  };\r\n\r\n  const storedDuration =\r\n    typeof window !== \"undefined\" ? Number(localStorage.getItem(\"duration\")) || 10 : 10;\r\n  const SESSION_DURATION = storedDuration;\r\n\r\n\r\n  const exercise =\r\n    typeof window !== \"undefined\" ? localStorage.getItem(\"exercise\") || \"squat\" : \"squat\";\r\n\r\n  useEffect(() => {\r\n    async function initCamera() {\r\n      try {\r\n        const camStream = await navigator.mediaDevices.getUserMedia({ video: true });\r\n        setStream(camStream);\r\n        if (videoRef.current) {\r\n          videoRef.current.srcObject = camStream;\r\n        }\r\n      } catch (err) {\r\n        alert(\"Camera access is required to start the session.\");\r\n      }\r\n    }\r\n    initCamera();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (stream && countdown !== null) {\r\n      if (countdown === 0) {\r\n        setCountdown(null);\r\n        startSession();\r\n      } else {\r\n        const timeout = setTimeout(\r\n          () => setCountdown((prev) => (prev !== null ? prev - 1 : null)),\r\n          1000\r\n        );\r\n        return () => clearTimeout(timeout);\r\n      }\r\n    }\r\n  }, [countdown, stream]);\r\n\r\n  const startSession = () => {\r\n    setSessionStarted(true);\r\n    const chunks: Blob[] = [];\r\n\r\n    if (stream) {\r\n      const mediaRecorder = new MediaRecorder(stream);\r\n      mediaRecorderRef.current = mediaRecorder;\r\n\r\n      mediaRecorder.ondataavailable = (e) => {\r\n        if (e.data.size > 0) chunks.push(e.data);\r\n      };\r\n\r\n      mediaRecorder.onstop = () => {\r\n        const blob = new Blob(chunks, { type: \"video/webm\" });\r\n        const url = URL.createObjectURL(blob);\r\n        setVideoURL(url);\r\n        setRecordedChunks(chunks);\r\n        sendToBackend(blob);\r\n\r\n        if (audioRef.current) {\r\n          audioRef.current.pause();\r\n          audioRef.current.currentTime = 0;\r\n          audioRef.current = null;\r\n        }\r\n      };\r\n\r\n      mediaRecorder.start();\r\n\r\n      const selectedSong = localStorage.getItem(\"selectedSong\") || \"none\";\r\n      if (selectedSong !== \"none\" && songMap[selectedSong]) {\r\n        const audio = new Audio(songMap[selectedSong]);\r\n        audio.volume = 0.4;\r\n        audioRef.current = audio;\r\n        audio.play().catch((err) => {\r\n          console.warn(\"Song failed to play:\", err);\r\n        });\r\n      }\r\n\r\n      let remaining = SESSION_DURATION;\r\n      setTimer(remaining);\r\n      const interval = setInterval(() => {\r\n        remaining--;\r\n        setTimer(remaining);\r\n        if (remaining <= 0) {\r\n          clearInterval(interval);\r\n          mediaRecorder.stop();\r\n          stream.getTracks().forEach((track) => track.stop());\r\n        }\r\n      }, 1000);\r\n    }\r\n  };\r\n\r\n  const sendToBackend = async (blob: Blob) => {\r\n    const formData = new FormData();\r\n    formData.append(\"video\", blob, `${exercise}_video.webm`);\r\n\r\n    try {\r\n      const response = await fetch(`http://localhost:5000/upload-${exercise}`, {\r\n        method: \"POST\",\r\n        body: formData,\r\n      });\r\n\r\n      const result = await response.json();\r\n      console.log(\"Server response:\", result);\r\n\r\n      if (exercise === \"squat\") {\r\n        window.location.href = `/session/result?exercise=squat&total=${result.total_squats}&good=${result.good_squats}&bad=${result.bad_squats}`;\r\n      } else if (exercise === \"pushup\") {\r\n        window.location.href = `/session/result?exercise=pushup&total=${result.total_pushups}&good=${result.good_pushups}&bad=${result.bad_pushups}`;\r\n      } else if (exercise === \"lunges\") {\r\n        window.location.href = `/session/result?exercise=lunges&total=${result.total_lunges}&good=${result.good_lunges}&bad=${result.bad_lunges}`;\r\n      } else if (exercise === \"plank\") {\r\n        const warnings = encodeURIComponent(result.warnings?.join(\"; \") || \"\");\r\n        window.location.href = `/session/result?exercise=plank&duration=${result.plank_duration_sec}&badframes=${result.bad_posture_frames}&warnings=${warnings}`;\r\n      } else {\r\n        alert(\"Unsupported exercise type!\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error uploading video:\", error);\r\n      alert(\"Failed to send video to backend.\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col items-center justify-center min-h-screen p-2\">\r\n      <h1 className=\"text-2xl font-bold mb-4\">\r\n        üèãÔ∏è Start Your {exercise.charAt(0).toUpperCase() + exercise.slice(1)} Session\r\n      </h1>\r\n\r\n      {!sessionStarted && countdown !== null && (\r\n        <div className=\"text-4xl font-bold text-blue-600\">\r\n          Your time starts in {countdown}...\r\n        </div>\r\n      )}\r\n\r\n      {sessionStarted && timer !== null && (\r\n        <div className=\"text-5xl font-bold text-red-600 mb-4\">{timer}</div>\r\n      )}\r\n\r\n      <video\r\n        ref={videoRef}\r\n        autoPlay\r\n        playsInline\r\n        muted\r\n        className=\"rounded shadow-md w-[90vw] h-[100vh] object-cover\"\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}